<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <script src="js/jq.js"> </script>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <link rel="stylesheet" type="text/css" href="css/style.css"/>
  <style type="text/css">

      body {
        font: 10px sans-serif;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .bar {
        fill: steelblue;
      }

      .x.axis path {
        display: none;
      }

  </style>
</head>
<body>

<script>
// initial render

render_svg("data.csv");


// Determine a time range

function makeDate(string) {
  var time = string.split(" ");
  var month = time[0];
  var year = time[1];
  console.log("month: " + month);
  console.log("year: " + year);
  return month + ":" + year;
  // do something here with bhavik's code
}

var default_start = "Jan 2013";
var default_end = "Oct 2013";

var start = makeDate(default_start);
var end = makeDate(default_end);

function getStart() {
  console.log(start);
  return start;
};

// listen to textbox
window.onload = function () {
    var start_input = document.getElementById('start_date');
    var end_input = document.getElementById('end_date');

    start_input.onkeypress = function () {
      if(event.keyCode == 13) {
        start = makeDate(this.value);
      };
    };

    end_input.onkeypress = function () {
      if(event.keyCode == 13) {
        end = makeDate(this.value);
        console.log(end);
        console.log(start);
      };
    };
};

document.write("<br>");
document.write("<br>");
document.write("<input type='text' id='start_date' />");
document.write("<input type='text' id='end_date' />");

// Most Popular Section  
document.write("<br>");
document.write("<br>");
document.write("<p class='popular'> Most Popular </p>");
  

  var colors = ["#6363FF", "#63FFCB","#FBFF63", "#FFB363", "#FF7363", "#FF6364"];
  var types = ["Status", "Link", "Like", "Photo", "Video"];

  function show_status(status) {
      var newP = document.createElement("p");
      var text = document.createTextNode(status);
      newP.className = "status";
      // img.width = "300px";
      newP.appendChild(text);
      // // This next line will just add it to the <body> tag
      document.body.appendChild(newP);
  }

  function show_photo(link) {
      var newDiv = document.createElement("div");
      var img = document.createElement("img");
      img.src = link;
      newDiv.className = "photo";
      newDiv.appendChild(img);
      // // This next line will just add it to the <body> tag
      document.body.appendChild(newDiv);
  }

  function show_video(link) {
      document.write("<div id='video_holder'> <video controls class='video' id='popular_video'></video> </div>");
      d3.select("#popular_video").src = link;
      var source = document.createElement("source");
      source.src = link;
      document.getElementById("popular_video").appendChild(source);
  }

  function update_status(status) {
    // how to update
    d3.select(".status").text(status);
  }

  function update_photo(photo) {
    document.querySelector(".photo > img").src = photo;
    $(".photo").load();
    //console.log(d3.select(".photo")); // = photo;
  }

  function update_video(video) {
    document.querySelector("#popular_video > source").src = video;
    $("#video_holder video").load();
  }

  function add_title(title, color) {
    var newDiv = document.createElement("div");
    if (title == "Video") {
      newDiv.className = "title-video";
    } else {
      newDiv.className = "title";
    };
    newDiv.id = title;
    newDiv.appendChild(document.createTextNode(title));
    document.body.appendChild(newDiv);
    d3.select("#"+title).style("color", color);
  }

  function show(type, color, arg) {
    add_title(type, color);
    if (type == "Status") {
      show_status(arg);
    } else if (type == "Photo") {
      show_photo(arg);
    } else if (type == "Video") {
      document.write("<br>");
      show_video(arg);
    } else if (type == "Link") {
      show_status(arg);
    } else {
      console.log("wrong type");
    }
  }

  // fake data - real: getMostPopular(start, end, type)
  var status = "He is so cute <3";
  var image_link = "test.jpg";
  var image_link_2 = "http://i.imgur.com/rSf6qRk.jpg";
  var video_link = "https://fbcdn-video-a.akamaihd.net/hvideo-ak-ash3/v/867980_10151488114683049_22347748_n.mp4?oh=99665a09b75b87cbb01f31f876cbc271&oe=525CDD19&__gda__=1381868364_e8b8abeb0360870b1fd0017848abe658";
  var video_link_2 = "https://fbcdn-video-a.akamaihd.net/hvideo-ak-ash2/v/1221211_10153092789985483_52714_n.mp4?oh=fc588ce882fba7c26a6946d6a2dbc8aa&oe=525CC9A8&__gda__=1381825525_807035f65adf4b8f0bc8d7d880ec78e4";
  var link_link = "google.com";
  var args = [status, link_link, null, image_link, video_link];
  
  var i = 0;
  for (var i =0; i<types.length; i+=1) {
    var t = types[i];
    if (t == "Like") {
      continue;
    }
    show(t, colors[i], args[i]);
  }

function change_input() {
  //get start and end from input
  getData(start, end);
}

function re_render(jsonObject) {
  translate(jsonObject);
  render_svg("temp.csv");
  for (var ty in types) {
    arg = getMostPopular(ty, jsonObject);
    update(ty, arg);
  };
}

function update(ty, arg) {
  if (ty == "Status") {
    update_status(arg);
  } else if (ty == "Photo") {
    update_photo(arg);
  } else if (ty == "Video") {
    update_video(arg); 
  } else if (ty == "Link") {
    update_link(arg);
  }
}


// re-render

function render_svg(csvFile) {
  var margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = 500 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;

  var x = d3.scale.ordinal()
      .rangeRoundBands([0, width], .1);

  var y = d3.scale.linear()
      .rangeRound([height, 0]);

  var color = d3.scale.ordinal().range(["#6363FF", "#63FFCB","#FBFF63", "#FFB363", "#FF7363", "#FF6364"]);

  var type = d3.scale.ordinal().range(["Status", "Link", "Like", "Photo", "Video"]);

  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");

  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left")
      .tickFormat(d3.format(".2s"));

  var svg = d3.select("body").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    d3.csv(csvFile, function(error, data) {
      color.domain(d3.keys(data[0]).filter(function(key) { return key !== "Time"; }));
      type.domain(d3.keys(data[0]).filter(function(key) { return key !== "Time"; }));

    data.forEach(function(d) {
      var y0 = 0;
      d.types = color.domain().map(function(name) { return {name: name, y0: y0, y1: y0 += +d[name]}; });
      d.total = d.types[d.types.length - 1].y1;
    });

    x.domain(data.map(function(d) { return d.Time; }));
    y.domain([0, d3.max(data, function(d) { return d.total; })]);

    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text("Count");

    var Time = svg.selectAll(".Time")
        .data(data)
        .enter().append("g")
        .attr("class", "g")
        .attr("transform", function(d) { return "translate(" + x(d.Time
     ) + ",0)"; });

    Time.selectAll("rect")
        .data(function(d) { return d.types; })
        .enter().append("rect")
        .attr("width", x.rangeBand())
        .attr("y", function(d) { return y(d.y1); })
        .attr("height", function(d) { return y(d.y0) - y(d.y1); })
        .style("fill", function(d) { return color(d.name); })
        .attr("class", function(d) {return type(d.name); });

    var svg_new = svg;
    var legend = svg_new.selectAll(".legend")
        .data(color.domain().slice().reverse())
        .enter().append("g")
        .attr("class", "legend")
        .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

    legend.append("rect")
        .attr("x", width - 18)
        .attr("width", 18)
        .attr("height", 18)
        .on("mouseover", function(d) {
          current = d3.select(this);
          d3.selectAll("rect").style("opacity", 0.3)
          d3.selectAll("."+d)
          .style("opacity", 1);
          current.style("opacity", 1);
        })
        .on("mouseout", function(d) {
          d3.selectAll("rect").style("opacity", 1);

        })
        .style("fill", color);

    legend.append("text")
        .attr("x", width - 24)
        .attr("y", 9)
        .attr("dy", ".35em")
        .style("text-anchor", "end")
        .text(function(d) { return d; });

    function mouseover(d) {
      svg.selectAll("rect")
          .attr("fill", red);
    }

    function mouseout(d) {
    svg.selectAll("path.link.source-" + d.key)
        .attr("fill", blue);
    }

  });
}

var dataset = {
  "january 2010": {
    "status": [
      {
        "data":"he is so cute",
        "likes":["stephanie"],
        "comments":[]
      },
      {
        "data":"she sucks",
        "likes":["bah", "boo"],
        "comments":['stephanie']
      }
    ],
    "photos": [
    ]
}
}


function getMostPopular(type, JsonSubset) {
  var popObject = 0;
  var pops = 0;
  var popLikes = 0;
  var popComments = 0;
  for (var time in JsonSubset) {
    var timeSubset = JsonSubset[time];
    var typeData = timeSubset[type];
    
    for (var i in typeData) {
      var typeObject = typeData[i];
      var object = typeObject.data;
      var popularity = typeObject.likes.length + typeObject.comments.length;
      if ((pops < popularity) || (pops == 0)) {
        pops = popularity;
        popObject = object;
        popComments = typeObject.comments.length;
        popLikes = typeObject.likes.length;
      }
    }
    
  };
  return popObject;
}

console.log(getMostPopular("status", dataset));

</script>




<!-- translate to csv -->
<script> 
function translate(jsonObject) {

};
</script>


</body>
</html>  
